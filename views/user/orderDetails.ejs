<div class="container">
    <h1>ORDER DETAILS</h1>
    <% if (order.paymentMethod==='cod'||order.status == 'delivered') { %>
    <div class="order-header">
        <p><strong>Order #</strong> <%= order.orderId %></p>
        <button class="download-invoice" onclick="downloadInvoice('<%= order.orderId %>')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            Download Invoice
        </button>
    </div>
    <% } %>
   <div class="order-info">
  <% order.items.forEach(item => { %>
    <div class="product-details">
      <img src="/<%= item.imageUrl || '/images/default-product.jpg' %>" alt="<%= item.name %>">
      <div>
        <p><strong><%= item.name %></strong></p>
        <p><strong>₹<%= item.price.toLocaleString('en-IN') %></strong></p>
        <% if (item.color) { %>
          <p><strong>Color: </strong> <%= item.color %></p>
        <% } %>
        <p><strong>Quantity: </strong> <%= item.quantity %></p>
        <p><strong>Item Total: </strong> ₹<%=(item.price * item.quantity).toLocaleString('en-IN')%></p>
      </div>
    </div>
    <hr class="product-divider">
  <% }); %>
  
  <div class="order-total">
    <p><strong>Order Total: </strong> ₹<%= order.total.toLocaleString('en-IN') %></p>
  </div>
</div>

    <div class="shipping-details">
        <h2>SHIPPING DETAILS</h2>
        <p><strong><%= order.shippingAddress.name %></strong></p>
        <p>
            <%= order.shippingAddress.building %>, 
            <%= order.shippingAddress.city %>, 
            <%= order.shippingAddress.state %>, 
            <%= order.shippingAddress.pincode %>, 
            <%= order.shippingAddress.addressType %>
        </p>
        <p><strong>Phone: </strong> <%= order.shippingAddress.phone %></p>
    </div>

   <!-- <div class="status-timeline">
  <ul>
    <li class="status-item <%= order.status === 'PLACED' ? 'active' : (['PROCESSING','SHIPPED','DELIVERED'].includes(order.status) ? 'completed' : 'pending') %>">
      <div class="status-icon">
        <% if (order.status === 'PLACED') { %>
          •
        <% } else if (['PROCESSING','SHIPPED','DELIVERED'].includes(order.status)) { %>
          ✓
        <% } else { %>
          ○
        <% } %>
      </div>
      <div class="status-label">ORDER PLACED</div>
    </li>

    Step 2: Processing
    <li class="status-item <%= order.status === 'PROCESSING' ? 'active' : (['SHIPPED','DELIVERED'].includes(order.status) ? 'completed' : 'pending') %>">
      <div class="status-icon">
        <% if (order.status === 'PROCESSING') { %>
          •
        <% } else if (['SHIPPED','DELIVERED'].includes(order.status)) { %>
          ✓
        <% } else { %>
          ○
        <% } %>
      </div>
      <div class="status-label">PROCESSING</div>
    </li>

    <!-- Step 3: Out for Delivery -->
    <!-- <li class="status-item <%= order.status === 'SHIPPED' ? 'active' : (order.status === 'DELIVERED' ? 'completed' : 'pending') %>">
      <div class="status-icon">
        <% if (order.status === 'SHIPPED') { %>
          •
        <% } else if (order.status === 'DELIVERED') { %>
          ✓
        <% } else { %>
          ○
        <% } %>
      </div>
      <div class="status-label">OUT FOR DELIVERY</div>
    </li> -->

    <!-- Step 4: Delivered -->
    <!-- <li class="status-item <%= order.status === 'DELIVERED' ? 'active' : 'pending' %>">
      <div class="status-icon">
        <% if (order.status === 'DELIVERED') { %>
          •
        <% } else { %>
          ○
        <% } %>
      </div>
      <div class="status-label">DELIVERED</div>
    </li>
  </ul> -->



<!-- </div> -->

<%
  const steps = ['PLACED', 'PROCESSING', 'SHIPPED', 'DELIVERED'];
  const stepLabels = ['ORDER PLACED', 'PROCESSING', 'OUT FOR DELIVERY', 'DELIVERED'];

  // Default active step
  let activeStep = 0;

  if (order.status === 'PLACED') {
    activeStep = 0;
  } else if (order.status === 'PROCESSING') {
    activeStep = 1;
  } else if (order.status === 'SHIPPED') {
    activeStep = 2;
  } else if (order.status === 'DELIVERED') {
    activeStep = 3;
  }
%>

<!-- <div class="status-timeline">
  <ul>
    <% steps.forEach((step, index) => { 
         let statusClass = 'pending';
         if (index < activeStep) statusClass = 'completed';
         else if (index === activeStep) statusClass = 'active';
    %>
      <li class="status-item <%= statusClass %>">
        <div class="status-icon"> -->
          <!-- <% if (statusClass === 'active') { %>
            •
          <% } else if (statusClass === 'completed') { %>
            ✓
          <% } else { %>
            ○
          <% } %>
        </div>
        <div class="status-label"><%= stepLabels[index] %></div>
      </li>
    <% }) %>
  </ul>
</div> -->




    <% if (order.status.toUpperCase() === 'PENDING' || order.status.toUpperCase() === 'PROCESSING') { %>
        <div class="action-buttons">
            <button class="action-btn cancel-btn"
            data-order-id="<%= order._id %>"
                data-status="<%= order.status %>"
            onclick="openModal('cancel')">Cancel Order</button>
        </div>
    <% } else if (order.status.toUpperCase() === 'DELIVERED') { %>
        <div class="action-buttons">
            <button class="action-btn return-btn"
            data-order-id="<%= order._id %>"
                data-status="<%= order.status %>"
            onclick="openModal('return')">Return Item</button>
        </div>
    <% } %>

    <p class="inquiries">Any inquiries? <a href="/user/contact">Contact us</a></p> 

    <div class="order-status">
        <p><%= getStatusmessage(order.status) %></p>
        <ul>
            <% order.statusHistory.forEach(history => { %>
                <li>
                    <%= new Date(history.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) %>
                    <span><%= new Date(history.date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span>
                    <br>
                    <%= history.message %>
                </li>
            <% }) %>
        </ul>
    </div>
</div>
<!-- JSON.stringify({ "<%= order.status %>" }) -->

<!-- Cancel Order Modal -->
<div id="cancelModal" class="modal">
    <div class="modal-content">
        <h3>Cancel Order</h3>
        <p>Please tell us why you're canceling this order:</p>
        <textarea id="cancelReason" placeholder="Your reason..."></textarea>
        <div class="modal-actions">
            <button class="modal-btn modal-cancel"  data-order-id="<%= order._id %>" onclick="closeModal()">Cancel</button>
            <button class="modal-btn modal-submit" data-order-id="<%= order._id %>" onclick="submitCancel(event)">Submit Request</button>
        </div>
    </div>
</div>
<!-- Return Order Modal -->
<div id="returnModal" class="modal">
    <div class="modal-content">
        <h3>Return Item</h3>
        <p>Please tell us why you're returning this item:</p>
        <textarea id="returnReason" placeholder="Your reason..."></textarea>
        <div class="modal-actions">
            <button class="modal-btn modal-cancel"   type="button" data-order-id="<%= order._id %>" onclick="closeModal()">Cancel</button>
            <button class="modal-btn modal-submit"  type="button"  data-order-id="<%= order._id %>" onclick="submitReturn(event)">Submit Request</button>
        </div>
    </div>
</div>